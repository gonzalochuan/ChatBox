generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  passwordHash      String
  name              String?
  nickname          String?
  studentId         String?
  yearLevel         String?
  block             String?
  profession        String?
  schedule          String?
  avatarUrl         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  messages          Message[]
  enrollments       Enrollment[]
  roles             UserRole[]
  banners           Banner[]
  bannerUserTargets BannerUserTarget[]
}

model Channel {
  id        String       @id @default(cuid())
  name      String
  topic     String?
  kind      String
  createdAt DateTime     @default(now())
  messages  Message[]
  members   Enrollment[]
  pins      ChannelPin[]
}

model Message {
  id                 String   @id @default(cuid())
  channelId          String
  senderId           String?
  senderName         String
  senderAvatarUrl    String?
  text               String
  priority           String   @default("normal")
  contextSummary     String?
  contextHighlights  String?
  contextSuggestions String?
  contextTagline     String?
  contextMeta        String?
  createdAt          DateTime @default(now())

  channel Channel      @relation(fields: [channelId], references: [id])
  sender  User?        @relation(fields: [senderId], references: [id])
  pins    ChannelPin[]
}

model ChannelPin {
  id           String   @id @default(cuid())
  channelId    String
  messageId    String
  pinnedById   String?
  pinnedByName String?
  pinnedAt     DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id])
  message Message @relation(fields: [messageId], references: [id])

  @@unique([channelId, messageId])
}

model Subject {
  id    String       @id // subject code
  name  String?
  users Enrollment[]
}

model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  subjectId String?
  channelId String?
  createdAt DateTime @default(now())

  user    User     @relation(fields: [userId], references: [id])
  subject Subject? @relation(fields: [subjectId], references: [id])
  channel Channel? @relation(fields: [channelId], references: [id])
}

model UserRole {
  id     String @id @default(cuid())
  userId String
  role   String

  user User @relation(fields: [userId], references: [id])
}

model Banner {
  id        String    @id @default(cuid())
  title     String
  message   String
  kind      String    @default("info")
  isActive  Boolean   @default(false)
  startsAt  DateTime?
  endsAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?

  creator     User?              @relation(fields: [createdBy], references: [id])
  targets     BannerTarget[]
  userTargets BannerUserTarget[]
}

model BannerTarget {
  id          String  @id @default(cuid())
  bannerId    String
  targetType  String // "section" | "subject"
  targetValue String? // e.g., sectionId like SEC-1-A or subject code like MATH101

  banner Banner @relation(fields: [bannerId], references: [id])
}

model BannerUserTarget {
  id       String @id @default(cuid())
  bannerId String
  userId   String

  banner Banner @relation(fields: [bannerId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
}

model ActivityLog {
  id          String   @id @default(cuid())
  kind        String // e.g., "banner.create", "banner.update", "banner.delete"
  actorId     String?
  actorName   String?
  subjectType String? // e.g., "banner", "user"
  subjectId   String?
  message     String
  data        String?
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([kind, createdAt])
}
